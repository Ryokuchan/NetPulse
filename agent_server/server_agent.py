from fastapi import FastAPI, HTTPException
import secrets
import json
from typing import List, Dict
import logging
from datetime import datetime
import threading
import time
import requests

# FastAPI —Å –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
app = FastAPI(
    title="Agent Server",
    docs_url=None,
    redoc_url=None
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger('AgentServer')

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –∞–≥–µ–Ω—Ç–æ–≤
CONFIG = {
    "server_id": "agent-server-ru-01",
    "token": "ru-server-secret-token-12345",
    "country": "ru",
    "port": 8001,
    "main_server_url": "http://localhost:8000"
}

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
agents_db = {}  # {agent_id: agent_data}
tasks_queue = []  # [task1, task2, ...]
task_results = {}  # {task_id: result}


class AgentManager:
    @staticmethod
    def create_agent(name: str, capabilities: List[str] = None):
        """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –µ–≥–æ"""
        if capabilities is None:
            capabilities = ["http", "ping", "tcp", "dns"]

        agent_id = f"agent-{CONFIG['country']}-{secrets.token_hex(4)}"
        agent_token = secrets.token_hex(16)

        agent_data = {
            "id": agent_id,
            "name": name,
            "country": CONFIG['country'],
            "token": agent_token,
            "capabilities": capabilities,
            "status": "online",
            "current_tasks": 0,
            "max_tasks": 5,
            "created_at": datetime.now().isoformat(),
            "last_heartbeat": datetime.now().isoformat()
        }

        agents_db[agent_id] = agent_data
        logger.info(f"üÜï New agent created: {agent_id}")

        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞–±–æ—á—É—é —Ñ—É–Ω–∫—Ü–∏—é –∞–≥–µ–Ω—Ç–∞
        AgentManager.start_agent_worker(agent_data)

        return agent_data

    @staticmethod
    def start_agent_worker(agent_data: dict):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞–±–æ—á—É—é —Ñ—É–Ω–∫—Ü–∏—é –∞–≥–µ–Ω—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ"""

        def worker():
            agent_id = agent_data["id"]
            agent_token = agent_data["token"]

            logger.info(f"ü§ñ Agent worker started: {agent_id}")

            while agents_db.get(agent_id, {}).get("status") == "online":
                try:
                    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–∞–¥–∞—á—É —É —Å–µ—Ä–≤–µ—Ä–∞
                    response = requests.get(
                        f"http://localhost:{CONFIG['port']}/agent/pending-task",
                        params={
                            "agent_id": agent_id,
                            "agent_token": agent_token
                        },
                        timeout=10
                    )

                    if response.status_code == 200:
                        task_data = response.json()

                        if task_data.get("status") == "no_tasks":
                            # –ù–µ—Ç –∑–∞–¥–∞—á - –∂–¥–µ–º
                            time.sleep(10)
                            continue

                        if task_data.get("status") == "busy":
                            # –ê–≥–µ–Ω—Ç –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω - –∂–¥–µ–º
                            time.sleep(30)
                            continue

                        # –ü–æ–ª—É—á–∏–ª–∏ –∑–∞–¥–∞—á—É - –≤—ã–ø–æ–ª–Ω—è–µ–º
                        logger.info(f"üéØ Agent {agent_id} executing task: {task_data['id']}")

                        # –ò–º–∏—Ç–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
                        result = AgentManager.execute_task(task_data)

                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        requests.post(
                            f"http://localhost:{CONFIG['port']}/agent/submit-result",
                            params={
                                "task_id": task_data["id"],
                                "agent_id": agent_id,
                                "agent_token": agent_token
                            },
                            json=result
                        )

                        logger.info(f"‚úÖ Agent {agent_id} completed task: {task_data['id']}")

                    # –û–±–Ω–æ–≤–ª—è–µ–º heartbeat
                    agents_db[agent_id]["last_heartbeat"] = datetime.now().isoformat()

                    time.sleep(5)  # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏

                except Exception as e:
                    logger.error(f"‚ùå Agent {agent_id} error: {e}")
                    time.sleep(30)  # –ü–∞—É–∑–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

        # –ó–∞–ø—É—Å–∫–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
        thread = threading.Thread(target=worker, daemon=True)
        thread.start()

    @staticmethod
    def execute_task(task_data: dict) -> dict:
        """–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞—á—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"""
        check_type = task_data["check_type"]
        target = task_data["target"]

        # –ò–º–∏—Ç–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
        if check_type in ["http", "https"]:
            return {
                "status": "success",
                "status_code": 200,
                "response_time": 150,
                "checked_at": datetime.now().isoformat()
            }
        elif check_type == "ping":
            return {
                "status": "success",
                "reachable": True,
                "response_time": 50,
                "checked_at": datetime.now().isoformat()
            }
        elif check_type == "tcp":
            return {
                "status": "success",
                "port_open": True,
                "response_time": 100,
                "checked_at": datetime.now().isoformat()
            }
        else:
            return {
                "status": "success",
                "response_time": 80,
                "checked_at": datetime.now().isoformat()
            }

    @staticmethod
    def get_agent(agent_id: str):
        return agents_db.get(agent_id)

    @staticmethod
    def get_all_agents():
        return list(agents_db.values())

    @staticmethod
    def get_online_agents():
        return [agent for agent in agents_db.values() if agent["status"] == "online"]

    @staticmethod
    def verify_agent(agent_id: str, token: str):
        agent = agents_db.get(agent_id)
        return agent and agent["token"] == token

    @staticmethod
    def verify_server_token(token: str):
        return token == CONFIG['token']

    @staticmethod
    def stop_agent(agent_id: str):
        if agent_id in agents_db:
            agents_db[agent_id]["status"] = "stopped"
            logger.info(f"üõë Agent stopped: {agent_id}")
            return True
        return False


class TaskManager:
    @staticmethod
    def add_task(task_data: dict):
        """–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –≤ –æ—á–µ—Ä–µ–¥—å"""
        tasks_queue.append(task_data)
        logger.info(f"üì• Task added to queue: {task_data['id']}")

    @staticmethod
    def get_pending_task_for_agent(agent_capabilities: List[str]):
        """–ù–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â—É—é –∑–∞–¥–∞—á—É –¥–ª—è –∞–≥–µ–Ω—Ç–∞"""
        for task in tasks_queue:
            if (task.get("status") == "pending" and
                    task.get("check_type") in agent_capabilities):
                return task
        return None

    @staticmethod
    def update_task_status(task_id: str, status: str, agent_id: str = None):
        """–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏"""
        for task in tasks_queue:
            if task.get("id") == task_id:
                task["status"] = status
                if agent_id:
                    task["assigned_agent"] = agent_id
                break


# ==================== API ENDPOINTS ====================

@app.post("/create-agent")
async def create_agent(name: str, server_token: str, capabilities: List[str] = None):
    """–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞"""
    if not AgentManager.verify_server_token(server_token):
        raise HTTPException(status_code=401, detail="Invalid server token")

    agent_data = AgentManager.create_agent(name, capabilities)

    return {
        "status": "success",
        "message": f"Agent created and started in {CONFIG['country']}",
        "agent": {
            "id": agent_data["id"],
            "name": agent_data["name"],
            "country": agent_data["country"],
            "capabilities": agent_data["capabilities"],
            "status": agent_data["status"]
        },
        "agent_server": {
            "id": CONFIG["server_id"],
            "country": CONFIG["country"],
            "url": f"http://localhost:{CONFIG['port']}"
        }
    }


@app.post("/assign-task")
async def assign_task(task_data: dict, server_token: str):
    """–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –∑–∞–¥–∞—á—É —ç—Ç–æ–º—É —Å–µ—Ä–≤–µ—Ä—É –∞–≥–µ–Ω—Ç–æ–≤"""
    if not AgentManager.verify_server_token(server_token):
        raise HTTPException(status_code=401, detail="Invalid server token")

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    task_data["status"] = "pending"
    task_data["country"] = CONFIG["country"]

    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ –æ—á–µ—Ä–µ–¥—å
    TaskManager.add_task(task_data)

    logger.info(f"üìã Task assigned: {task_data['id']} - {task_data['check_type']} for {task_data['target']}")

    return {
        "status": "success",
        "message": f"Task added to queue in {CONFIG['country']}",
        "task_id": task_data["id"],
        "queue_size": len(tasks_queue)
    }


@app.get("/agents")
async def list_agents(server_token: str):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤"""
    if not AgentManager.verify_server_token(server_token):
        raise HTTPException(status_code=401, detail="Invalid server token")

    online_agents = AgentManager.get_online_agents()

    return {
        "status": "success",
        "agents": AgentManager.get_all_agents(),
        "stats": {
            "total": len(agents_db),
            "online": len(online_agents),
            "offline": len(agents_db) - len(online_agents),
            "pending_tasks": len([t for t in tasks_queue if t.get("status") == "pending"]),
            "active_tasks": len([t for t in tasks_queue if t.get("status") == "assigned"])
        }
    }


@app.post("/stop-agent")
async def stop_agent(agent_id: str, server_token: str):
    """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≥–µ–Ω—Ç–∞"""
    if not AgentManager.verify_server_token(server_token):
        raise HTTPException(status_code=401, detail="Invalid server token")

    success = AgentManager.stop_agent(agent_id)

    if success:
        return {"status": "success", "message": f"Agent {agent_id} stopped"}
    else:
        raise HTTPException(status_code=404, detail="Agent not found")


# ==================== API –î–õ–Ø –ê–ì–ï–ù–¢–û–í ====================

@app.get("/agent/pending-task")
async def get_pending_task(agent_id: str, agent_token: str):
    """–ê–≥–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∑–∞–¥–∞—á—É"""
    if not AgentManager.verify_agent(agent_id, agent_token):
        raise HTTPException(status_code=401, detail="Invalid agent credentials")

    agent = AgentManager.get_agent(agent_id)
    if not agent or agent["status"] != "online":
        return {"status": "offline"}

    if agent["current_tasks"] >= agent["max_tasks"]:
        return {"status": "busy"}

    # –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â—É—é –∑–∞–¥–∞—á—É –¥–ª—è —ç—Ç–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
    task = TaskManager.get_pending_task_for_agent(agent["capabilities"])
    if task:
        # –ù–∞–∑–Ω–∞—á–∞–µ–º –∑–∞–¥–∞—á—É –∞–≥–µ–Ω—Ç—É
        TaskManager.update_task_status(task["id"], "assigned", agent_id)
        agent["current_tasks"] += 1
        agent["last_heartbeat"] = datetime.now().isoformat()

        logger.info(f"üéØ Task {task['id']} assigned to agent {agent_id}")

        return task

    return {"status": "no_tasks"}


@app.post("/agent/submit-result")
async def submit_result(task_id: str, agent_id: str, agent_token: str, result: dict):
    """–ê–≥–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–¥–∞—á–∏"""
    if not AgentManager.verify_agent(agent_id, agent_token):
        raise HTTPException(status_code=401, detail="Invalid agent credentials")

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
    TaskManager.update_task_status(task_id, "completed")

    # –û–±–Ω–æ–≤–ª—è–µ–º –∞–≥–µ–Ω—Ç–∞
    agent = AgentManager.get_agent(agent_id)
    if agent:
        agent["current_tasks"] = max(0, agent["current_tasks"] - 1)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    task_results[task_id] = result

    logger.info(f"‚úÖ Result submitted for task {task_id} by agent {agent_id}")

    return {"status": "success"}


@app.post("/agent/heartbeat")
async def agent_heartbeat(agent_id: str, agent_token: str):
    """–ê–≥–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç heartbeat"""
    if not AgentManager.verify_agent(agent_id, agent_token):
        raise HTTPException(status_code=401, detail="Invalid agent credentials")

    agent = AgentManager.get_agent(agent_id)
    if agent:
        agent["status"] = "online"
        agent["last_heartbeat"] = datetime.now().isoformat()

    return {"status": "success"}


@app.get("/task-result/{task_id}")
async def get_task_result(task_id: str, server_token: str):
    """–ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–¥–∞—á–∏"""
    if not AgentManager.verify_server_token(server_token):
        raise HTTPException(status_code=401, detail="Invalid server token")

    result = task_results.get(task_id)
    if result:
        return {"status": "success", "result": result}
    else:
        return {"status": "not_found"}


@app.get("/status")
async def server_status():
    """–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞ –∞–≥–µ–Ω—Ç–æ–≤"""
    online_agents = AgentManager.get_online_agents()
    pending_tasks = len([t for t in tasks_queue if t.get("status") == "pending"])

    return {
        "status": "running",
        "server_id": CONFIG["server_id"],
        "country": CONFIG["country"],
        "agents_count": len(agents_db),
        "online_agents": len(online_agents),
        "pending_tasks": pending_tasks,
        "main_server": CONFIG["main_server_url"]
    }


@app.get("/")
async def root():
    return {"message": f"Agent Server {CONFIG['server_id']} is running"}


# ==================== –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê ====================

if __name__ == "__main__":
    print(f"üöÄ Starting Agent Server...")
    print(f"üîë Server ID: {CONFIG['server_id']}")
    print(f"üåç Country: {CONFIG['country']}")
    print(f"üîê Token: {CONFIG['token']}")
    print(f"üì° Port: {CONFIG['port']}")
    print(f"üìç URL: http://localhost:{CONFIG['port']}")
    print("=" * 50)

    import uvicorn

    uvicorn.run(
        app,
        host="0.0.0.0",
        port=CONFIG["port"],
        access_log=False
    )